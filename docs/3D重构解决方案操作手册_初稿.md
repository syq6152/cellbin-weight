# 3D重构的意义

三维（three dimensions，3D）重构是当前生命科学领域的研究热点之一。通过构建三维图谱，能够从细胞的海量转录组数据中还原细胞与分子的整体分布情况，这为破解诸多研究中的未解之谜提供了关键助力，例如器官功能的解析、胚胎发育的机制探索、癌症及其他复杂疾病的发病原理研究，以及物种演化历程的追溯等。

这种技术打破了传统二维观测的局限，让研究者得以在更贴近生物实体原本空间构型的维度上，理解基因表达、细胞互作与生物表型之间的关联，为生命科学的基础研究和临床转化（如疾病诊断标志物发现、靶向治疗方案设计等）开辟了新的视角和路径。

# STOMICS 3D重构解决方案全流程和功能亮点介绍

传统空间转录组技术仅能提供组织切片的二维信息，无法完整呈现生物样本的三维结构和细胞间空间关系。即便能实现高分辨率的基因表达位置检测，仍需专门的三维重构工具解决以下挑战：

*   连续组织切片的精准空间配准
    
*   多切片数据的整合与标准化
    
*   细胞类型和基因表达模式的三维可视化
    
*   跨切片细胞轨迹和发育过程的重建
    

而Stereo3D 是由华大时空组学研发的三维重构分析平台，可通过整合多切片空间信息，实现组织和器官水平的三维基因表达图谱构建，为发育生物学、疾病机制研究和组织工程提供全新视角。

Stereo3D的核心优势更使其成为研究利器：

*   **极强通用性：**灵活适配仅图像、仅矩阵或图像与矩阵结合等多种场景，满足不同数据的分析需求；
    
*   **高效低成本：**大幅度降低人力成本，缩短分析周期（果蝇Demo在内存32G电脑运行，十分钟内可出结果）。
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/d8a4d81a-5e5c-4ebc-902b-0b88532cf79e.png)

图1 3D重构解决方案全流程

## 湿实验部分介绍  （仅做参考，附上链接，不做详细介绍，与官网关联）

在 Stereo3D 的整体工作流程中，湿实验部分是获取原始数据的关键环节。该部分实验基于基于华大自主研发的 Stereo-seq 技术，通过时空芯片捕获组织切片的 mRNA 信息。实验流程包括新鲜组织精准切片、贴至时空芯片，经逆转录与 cDNA 扩增后，记录芯片各位点的基因表达数据。华大配套试剂盒含标准化试剂，保障实验稳定性与数据可靠性。

若想了解更多关于湿实验相关的产品与技术细节，可访问华大官网：[https://www.bgi.com/](https://www.bgi.com/) 。

## 数据分析流程介绍

Stereo3D 数据分析流程以自动化、标准化为核心，高效实现从原始数据到三维重构结果的转化。在输入层面，支持 GEM/GEF 格式基因表达矩阵、组织分割图，以及记录切片位置的切片流水表。

流程启动后，先对组织分割图进行预处理，实现空间对齐，构建统一三维坐标系；随后进行矩阵转换，注释等基础分析；最后输出配准后的组织分割图、H5AD 数据、三维模型（OBJ）等，助力科研人员快速获取三维空间洞察，解决传统方法效率低、人力成本高的问题。

## 自动化解决方案

3D重构解决方案目前有两种自动化方式，Stereo3D和Spateo。

Stereo3D的标准化流程通过整合影像学图像与基因表达矩阵实现三维重构，同时支持仅基于图像或仅基于矩阵的数据做三维重构。若样本形态完整且需结合组织形态分析，优先使用Stereo3D。

Spateo与Stereo3D区别是不依赖于影像学图像，完全基于基因表达矩阵，通过统计学生成模型实现无图像依赖的三维重构。若样本形态差异大，推荐使用Spateo。

### Stereo3D

#### 安装及使用

Stereo3D 是开源 Python 工具，支持在 Linux、macOS 系统中部署。以下为快速上手步骤：

1.  安装环境准备
    
    请先安装 Anaconda 软件（ [Anaconda 官方文档](https://docs.anaconda.com/anaconda/install/)），然后执行以下操作：
    
2.  安装 Stereo3D
    

```plaintext
# Clone the repository and navigate to the directory
git clone https://github.com/STOmics/stereo3d
cd stereo3d

# Create and activate the Conda environment
conda create --name=stereo3d python=3.8
conda activate stereo3d

# Install dependencies
pip install -r requirements.txt
```

3.  运行 stereo3d\_with\_matrix.py
    

```plaintext
python stereo3d_with_matrix.py \
--matrix_path E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.gem \
--tissue_mask E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.mask \
--record_sheet E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\E-ST20220923002_slice_records_E14_16.xlsx \
--output E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\output
```

更多安装细节、参数配置及案例教程，可访问[Stereo3D GitHub 仓库](https://github.com/STOmics/stereo3d)；若遇问题，欢迎通过 GitHub Issues 提交反馈或参与讨论。

####  输入参数介绍

若您拿到的是SAW的标准输出结果，需先使用Stereo3D中的小工具saw\_hub.py（详情查看3.2.1 Stereo3D输入规范化）将数据转换为Stereo3D的标准输入格式。

表1 Stereo3D标准输入参数介绍

| **输入** | **介绍** | **必要性** | **数据类型** |
| --- | --- | --- | --- |
| matrix\_path | 标准格式的基因表达矩阵 | 必需 | string |
| tissue\_mask | 组织分割图 | 必需 | string |
| record\_sheet | 从实验端获取，记录切片位置，前后张切片的对应关系 | 必需 | string |
| output | 结果保存路径 | 必需 | string |
| registration | 流程默认做配准，如输入的数据本身已配准，无需算法额外做配准，则传参数--registration 0 | 可选 | int |

#### 输出文件介绍

| **输出文件** | **介绍** |
| --- | --- |
| 02.register | Registered tissue mask images after alignment |
| 03.gem | Spatial expression matrix after registration |
| 04.mesh | 3D mesh model reconstructed from clustered point clouds |
| 05.transform | Annotated H5AD file containing spatial coordinates and cell metadata |
| 06.color | H5AD file with unified color mapping for visualization |
| 07.organ | Segmented organ-specific mesh models |

#### 结果查看

完成数据规范化并运行stereo3d\_with\_matrix.py输出结果后，可通过以下方式查看结果。

1.  **配准结果查看**
    

由于图像和矩阵是一一对应的关系，矩阵转换复用的是图像配准的关系，所以只要查看图像配准是否正确即可。

在输出结果里02.register文件夹内包含00.crop\_mask（裁剪后的tissue mask）和01.align\_mask（配准后的tissue mask）

| 工具 | 版本 | 简介 | 下载链接 | 作用 |
| --- | --- | --- | --- | --- |
| Fiji | ImageJ 1.54f | Fiji 是基于 ImageJ 的免费开源图像处理软件，支持荧光显微图像、3D 重构、细胞计数等功能。 | [https://imagej.net/software/fiji/downloads](https://imagej.net/software/fiji/downloads) | *   配准结果查看<br>    <br>*   配准结果手动修改 |

注意：用Fiji软件查看，导入到TrakEM2是按照文件名排序展示的（按照默认的字母数字顺序），因此建议将文件名命名按照切片流水表的顺序命名（如image1.tif，image2.tif），确保前后张关系正确。

*   建立项目：打开Fiji软件，建立一个空的TrakEM2；
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/c1d1aa22-4925-4356-851a-44ed8a6f18fe.png)

*   选择目录：在“Select storage folder”窗口中选择01.align\_mask（图像所在目录）；
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/455c6505-b78b-45b7-be99-e2149ef09827.png)

*   移除其它文件：将01.align\_mask文件夹中的align\_info.json移出该文件夹（导入TrakEM2中的文件夹，只能有图，不能有其它文件）；
    
*   导入文件夹：将01.align\_mask文件夹拖进“Canvas”（最大的图像显示区域）；“Import directory”窗口点击“OK”；“Slice separation”窗口，勾选“Lock stack”；
    
    ![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/3b9a3824-473c-4efa-ab47-086582b7776b.png)
    
    ![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/0e9a2c8c-86e2-4d68-af92-8c2c3e3d9c8f.png)  
    
    ![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/5169b0e1-1dc0-4bde-bf98-1737249ea6bd.png)
    
*   调整图像位置：如需调整图像在“Canvas”的显示位置，先将鼠标放在“Preview thumbnail”上，按住“Ctrl”，滚动鼠标，即可调整图像在“Canvas”的显示位置；且可点击“Preview thumbnail”的红框，上下左右移动，直至图像显示适合；
    
    ![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/ecb287a8-945a-4780-9373-6fad0962de57.png)
    
*   图层捆绑接触：“Patches”窗口，取消捆绑（即参考图像后续可进行位置变换）；
    
    ![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/68889406-2646-462f-a27c-180d84ddb7df.png)
    
*   切换到“Layers”窗口：“Layers”窗口，左侧指示条数量等于导入的文件夹内的文件数量。滚动鼠标，可见指示条轮流显示为绿色，“Canvs”轮流呈现不同的图像；
    
    ![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/08b8781c-a459-4194-87cc-9df6b87f508a.png?x-oss-process=image/crop,x_0,y_0,w_1217,h_817/ignore-error,1)
    
*   图像选择：参考图像的指示条显示为红色，调整图像的指示条显示为绿色；选中调整图像的指示条，选中即为绿色；按“Shift”键，点击左侧栏其它指示条，参考图像的指示条即显示为红色；
    
    ![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/0e3867d4-4945-42ab-9f89-b79f43df30d2.png)
    
*   查看配准结果：滚动鼠标，即可查看前后张配准情况。
    

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/d43c124d-259b-40b8-ae72-db16f97403a8.png)

1.  **H5AD结果可视化**
    
    输出结果06.color是已经统一坐标和标签的h5ad文件，使用Stereo3D中的小工具stereo3d\_viewer.ipynb进行可视化。具体操作可查看[《注释/聚类断点接入和展示》](https://alidocs.dingtalk.com/i/nodes/lyQod3RxJK3djBrof2e4bK7dJkb4Mw9r)**\---使用场景：注释/聚类效果展示**
    
2.  **mesh/organ可视化**
    

输出结果04.mesh是整个组织模型，07.organ是器官模型，使用3D Slicer进行可视化（模型以obj格式存储）。

| 工具 | 版本 | 简介 | 下载链接 | 作用 |
| --- | --- | --- | --- | --- |
| 3D Slicer | v4.11.20210226 | 支持对 CT、MRI 等多维医学数据进行三维重建、分割及可视化操作等。 | [https://download.slicer.org/](https://download.slicer.org/) | *   模型可视化<br>    <br>*   修改模型外轮廓 |

注意：obj保存路径不能中文命名

*   导入文件，将04.mesh文件夹里的文件拖进3D Slicer；
    

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/657f711c-b4ee-44d7-af77-8279ed9d0f50.png?x-oss-process=image/crop,x_9,y_11,w_736,h_429/ignore-error,1)

*   查看结果：在3D视图内，点击左上角的 center the 3D 按钮可还原模型位置，滚动鼠标即可放大/缩小模型（按住鼠标左键可随意角度查看模型；按住鼠标右键或鼠标滚轮可调节模型大小。）
    

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/a67650b5-cc97-45ba-ba68-534b8a820aa6.png)

*   mesh和organ可视化：将07.organ文件夹的文件拖进3D Slicer，与mesh一起展示；
    

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/afd8a515-930a-4049-95d3-78a46f3fc827.png)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/47a72e4e-59c3-4c56-91b5-0e8a785ab271.png)

*   模型展示的颜色调整：在“Models”，双击颜色窗口，跳出“Slicer”窗口，选择颜色，即可改变展示的颜色；
    

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/9a662521-0611-45ea-99be-4b15cd1d7e5a.png)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/bbcb91ab-f3de-4948-93c5-ec158e36b784.png?x-oss-process=image/crop,x_1544,y_51,w_1007,h_689/ignore-error,1)

*   obj部分展示：点击眼睛图标，眼睛关闭即不展示，眼睛打开即展示。
    

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/b7658629-3f34-4df9-baef-9d10a37a811b.png)

### Spateo

Spateo 专注于空间转录组数据的三维重构、空间模式挖掘等计算分析（如切片配准、细胞轨迹构建）；而Spateo-viewer 是配套的可视化工具，专为展示 Spateo 的分析结果设计，可将复杂的三维空间结构、基因表达模式等以交互式方式呈现，二者形成 “分析 - 可视化” 的完整工作流。

#### 安装及使用

Spateo 是基于 Python 开发的工具，以下为快速上手步骤：

1.  安装环境准备
    
    请先安装 Anaconda 软件（ [Anaconda 官方文档](https://docs.anaconda.com/anaconda/install/)），然后执行以下操作：
    
2.  安装Spateo和Spateo-view
    
    ```plaintext
    # Clone the repository and navigate to the directory
    git clone https://github.com/STOmics/stereo3d
    cd stereo3d/stereo3d/tools
    
    # Create and activate the Conda environment
    conda create --name=spateo python=3.9
    conda activate spateo
    
    # Install dependencies
    pip install pymeshfix
    pip install pyacvd
    pip install scanpy
    pip install spateo-release==1.1.1
    ```
    
    ```plaintext
    # Clone the repository and navigate to the directory
    git clone https://github.com/aristoteleo/spateo-viewer.git
    cd spateo-viewer
    
    # Install dependencies
    pip install -r requirements.txt
    
    #Note: vtk==9.2.2 can solve TypeError: Could not find a suitable VTK type for <U54
    ```
    
3.  运行 spateo\_3d.py和stv\_explorer.py
    

```plaintext
python spateo_3d.py \
-input D:\RD_Data\3D\spateo_data\E14-16h_a_count_normal_stereoseq.h5ad \
-output D:\RD_Data\3D\spateo_data\output \
-z_step 1 \
-slice slice_ID \
-cluster annotation \
-cluster_pts 1000
```

```plaintext
python stv_explorer.py --port 1234
```

*   更多安装细节、参数配置及案例教程，可访问[spateo-release GitHub](https://github.com/aristoteleo/spateo-release)仓库和[spateo-viewer GitHub](https://github.com/aristoteleo/spateo-viewer)仓库
    
*   Spateo文章：[https://www.cell.com/cell/fulltext/S0092-8674(24)01159-0](https://www.cell.com/cell/fulltext/S0092-8674\(24\)01159-0)
    
    #### 输入参数介绍
    
    | **输入** | **介绍** | **必要性** | **数据类型** |
    | --- | --- | --- | --- |
    | input | 文件或目录路径。<br>文件路径：所有切片都在一个文件中；<br>目录路径：所有切片都在一个目录下（文件名需包含数字以体现切片间关联） | 必需 | string |
    | output | 结果保存路径 | 必需 | int |
    | z\_step | 可根据 spateo-viewer 中的渲染效果，调整切片之间的距离 | 可选 | string |
    | cluster | h5ad 文件中，聚类信息所在的字段名称 | 可选 | int |
    | slice | h5ad 文件中，代表切片前后关联关系的字段名称 | 可选 | string |
    | cluster\_pts | 当用于描述 3D 组织表达信息的点数量过多时，可采用下采样，并用采样后的数据开展流程分析。此处为每类采样的点数量，点数较少时需谨慎使用 | 可选 | int |
    
    #### 输出文件介绍
    
    | **输出文件** | **介绍** |
    | --- | --- |
    | h5ad | AnnData object processed by count normalization and spatial alignment, containing gene expression matrix and spatial coordinate information. |
    | matrices | Raw or preprocessed gene expression matrix files |
    | mesh\_models | Segmented organ-specific mesh models |
    | pc\_models | Aligned organ-specific point cloud model containing coordinates and attributes of discrete cells/sites in 3D space |
    | plot | Visualized results file |
    | trans\_h5ad | AnnData after normalization, alignment, and secondary processing, with analysis data |
    
    #### 结果查看
    
    详情请查看[spateo-viewer GitHub](https://github.com/aristoteleo/spateo-viewer)仓库
    
    ## 手动辅助精修方案
    
    如果对于Stereo3D的自动化流程结果不满意，可以手动修改结果后接回流程。
    
    #### 手动配准
    
    如果Stereo3D自动化流程结果中配准结果错误，可手动配准，再接回Stereo3D输出新的自动化流程结果。具体操作请查看此文档[《手动配准SOP\_v1》](https://alidocs.dingtalk.com/i/nodes/93NwLYZXWyg6oqO1FvX5EgreJkyEqBQm?corpId=dingdaeb6f85c48618b9f2c783f7214b6d69&iframeQuery=utm_source%3Dportal%26utm_medium%3Dportal_new_tab_open&rnd=0.6391902675229961&sideCollapsed=true&utm_scene=team_space)
    
    #### 手动修改mesh
    
    对于Stereo3D自动化流程结果的mesh或organ结果不满意，可使用3D slicer进行手动修改。（由于模型结果不影响其他文件结果，无需接回Stereo3D流程）
    
    [《3Dslicer手动修改mesh/organSOP\_v1》](https://alidocs.dingtalk.com/i/nodes/Gl6Pm2Db8D30K1wofqZaoawzJxLq0Ee4?doc_type=wiki_doc)
    
    # 应用案例介绍
    
    ## 测试数据介绍
    
    | 物种组织 | 下载路径 | 文件大小 |
    | --- | --- | --- |
    | 果蝇 | https://bgipan.genomics.cn/#/link/wSnaxQhJ6i5RTPcYvtgI Extraction password:FJrY | 90 MB |
    
    ### 果蝇自动化流程展示
    
    1.  环境配置
        
        ```plaintext
        # Clone the repository and navigate to the directory
        git clone https://github.com/STOmics/stereo3d
        cd stereo3d
        
        # Create and activate the Conda environment
        conda create --name=stereo3d python=3.8
        conda activate stereo3d
        
        # Install dependencies
        pip install -r requirements.txt
        ```
        
    2.  代码运行
        
        ```plaintext
        python stereo3d_with_matrix.py \
        --matrix_path E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.gem \
        --tissue_mask E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.mask \
        --record_sheet E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\E-ST20220923002_slice_records_E14_16.xlsx \
        --output E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\output
        ```
        
    3.  log展示
        
        ![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/5bc75b9e-1d15-4c3a-a6de-a9db3f0ea65d.png)
        
    4.  输出结果展示
        
    
    ![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/06219592-7a05-41de-a11f-fcaa2674e456.png)      ![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/d2d4ab6a-d3af-4e51-8bb0-4902ec4364c3.png)
    
    两两之间的配准结果展示
    
    ![image3.gif](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/8f80c78c-f3f9-4e42-87c4-41c949739d9b.gif)   
    
    模型结果展示
    
    ![drosophila_melanogaster.gif](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jP2lRYKDKaYJ6O8g/img/3dba71ba-c2da-4cca-ba41-41e32bc05a59.gif)
    
    聚类后效果展示
    
    ## 场景介绍
    
    ### 图像和矩阵场景
    
    图像和矩阵场景是Stereo3D的标准化流程，详情可参考3.1.1 果蝇自动化流程展示
    
    ### 仅图像场景
    
    当仅有图像时，使用Stereo3D可生成组织的重构结果。--matrix\_path的输入填个路径即可，无需实际性的矩阵作为输入
    
    Usage
    
    ```plaintext
    python stereo3d_with_matrix.py \
    --matrix_path E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.gem \
    --tissue_mask E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.mask \
    --record_sheet E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\E-ST20220923002_slice_records_E14_16.xlsx \
    --output E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\output
    ```
    
    Output file
    
    | **File Name** | **Description** |
    | --- | --- |
    | 02.register | Registered tissue mask images after alignment |
    | 03.gem | Spatial expression matrix after registration |
    | 04.mesh | 3D mesh model reconstructed from clustered point clouds |
    | 05.transform | empty |
    | 06.color | empty |
    | 07.organ | empty |
    
    如组织的其中一个结构想单独展示，可将该结构聚成一类通过Stereo3D，生成结构模型。更多详情，欢迎通过 GitHub Issues 提交反馈或参与讨论。
    
    ### 仅矩阵场景
    
    当只有矩阵文件，没有图像时，可以使用Stereo3D进行重构。也可以选择使用Spateo进行重构，具体查看2.3.2 Spateo；
    
    #### Stereo3D---组织重构
    
    如想获取组织整体的mesh，可通过矩阵进行组织分割，将生成的组织分割掩码（mask）作为Stereo3D的输入，最终得到其标准输出结果。
    
    矩阵进行组织分割，可利用cellbin2，具体操作查看链接[https://github.com/STOmics/cellbin2/blob/main/cellbin2/config/demos/only\_matrix.json](https://github.com/STOmics/cellbin2/blob/main/cellbin2/config/demos/only_matrix.json)
    
    有矩阵的组织分割结果后，既有了Stereo3D的标准输入，后面流程参考3.1.1 果蝇自动化流程展示
    
    #### Stereo3D---矩阵重构
    
    如只想获取矩阵重构结果，可以使用Stereo3D中的paste参数，输出配准好的H5AD和器官mesh。
    
    Usage
    
    ```plaintext
    python stereo3d_with_matrix.py \
    --matrix_path D:\RD_Data\3D\Drosophila_melanogaster_demo\00.gem \
    --record_sheet D:\RD_Data\3D\E-ST20220923002_slice_records_E14_16.xlsx \
    --output D:\RD_Data\3D\Drosophila_melanogaster_demo\output \
    --align paste
    ```
    
    Input Parameters
    
    | **Name** | **Description** | **Importance** | **Dtype** |
    | --- | --- | --- | --- |
    | matrix | The path of matrix file | Required | string |
    | mask | The path of tissue cut file | Required | string |
    | record\_sheet | Record sheet file. We provide you with a sample, click for detail | Required | string |
    | output | The output path | Required | string |
    | align | Using the paste method to achieve alignment | Required | string |
    
    Output file
    
    | **File Name** | **Description** |
    | --- | --- |
    | 06.color | H5AD file with unified color mapping for visualization |
    | 07.organ | Segmented organ-specific mesh models |
    
    ## 智能辅助小工具介绍
    
    Stereo3D 还配备了一系列实用小工具以适配不同场景，以下将具体介绍这些工具在各类场景中的应用。
    
    ### Stereo3D输入规范化
    
    若您拿到的是SAW的标准输出结果，除手动规范化输入外，还可以使用Stereo3D中的小工具saw\_hub.py将数据转换为Stereo3D的标准输入格式。
    
    #### Usage
    
    ```shell
    python saw_hub.py \
    -input D:\data\stereo3d\input \
    -record D:\code\stereo3d\docs\E-ST20220923002_slice_records_20221110.xlsx \
    -stain ssDNA \
    -output D:\data\stereo3d\output \
    -saw_version 7
    ```
    
    #### Input Parameters
    
    | **Name** | **Description** | **Importance** | **Dtype** |
    | --- | --- | --- | --- |
    | input | SAW output dir | Required | string |
    | record | Input record sheet path | Required | string |
    | output | The output path | Required | string |
    | saw\_version | The version of SAW (7 or 8) | Required | int |
    | stain | The stain tech (ssDNA or HE) | Required | string |
    
    #### Output file
    
    | **File Name** | **Description** |
    | --- | --- |
    | gem | The [saw](https://github.com/STOmics/SAW) input files(gene matrix) |
    | mask | The [saw](https://github.com/STOmics/SAW) output files(`<SN>_<staintype>_tissue_cut.tif`), [details](https://stereotoolss-organization.gitbook.io/saw-user-manual-v8.2/analysis/outputs/count-outputs) |
    
    ### 芯片一贴多场景处理
    
    由于组织过小，在时空芯片上，贴多张切面或者是一个包埋块里，包埋多个组织进行切贴，结果都是一张芯片上会有多个组织。对于这种数据，在实验端需要xxxxxx（后面再补充）；在数据端需要将其拆分成单个组织，再输入到Stereo3D流程里进行重构。对于数据处理，有手动拆分方案和自动拆分方案。
    
    1.  手动拆分方案，主要使用的工具是StereoMap和SAW，具体操作请查看[《一贴多手动拆分方案》](https://alidocs.dingtalk.com/i/nodes/P7QG4Yx2Jp7moAR1H4Ar1DeeV9dEq3XD)
        
    2.  自动拆分方案，使用的是Stereo3D内的工具`multi_tissue.py`，具体操作请查看[《一贴多自动拆分方案》](https://alidocs.dingtalk.com/i/nodes/AR4GpnMqJzM3oe71CKwbxXNlVKe0xjE3)
        

### 注释/聚类结果断点接入功能

`anno_adata_support.py` 是一个专为空间转录组数据分析设计的工具，用于将已注释 / 聚类好的 H5ad 格式数据（Scanpy 标准）断点接入到 Stereo3D 分析流程中。该工具在原有 Stereo3D 分析结果的基础上，无缝整合外部注释数据，生成新的 Stereo3D 结果，同时保留原始分析流程的所有中间结果。

具体操作请查看[《注释/聚类断点接入和展示》](https://alidocs.dingtalk.com/i/nodes/lyQod3RxJK3djBrof2e4bK7dJkb4Mw9r)\---**使用场景：注释/聚类断点接入**

### 增加无矩阵图像进行重构

增加没有矩阵信息的图像来改善3D model，在Stereo3D流程中是可以走通的。将用于重构的sn完整填写在切片流水表里，前后张关系要对应正确，最后运行`stereo3d_with_matrix.py`即可。

```plaintext
python stereo3d_with_matrix.py \
--matrix_path E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\01.gem \
--tissue_mask E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.mask \
--record_sheet E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\E-ST20220923002_slice_records_E14_16.xlsx \
--output E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\output
```

# Q&A

1.  如果样本数量过少，或者说样本质量差，是否要丢弃？
    
    答复：如果是样本数量过少，那最好确保最佳的样本用于正式实验，保证关键位置无误（最好由客户去确认芯片贴片的起始点和停止点，客户是最清楚自己的需求）。样本质量差，对于重构影响是不大的，但是对于后续的数据分析影响会比较大，例如扩散、捕获量低、基因数过少等，建议不要质量差的样本。
    
2.  3D重构里，有个不强制的要求：相邻切片的bin50测序基因数量不超过30%；请问如果是不同的bin size，是否要做相应的调整？
    
    答复：要的，不同的bin size要做相应的调整。
    
3.  3D重构与spateo更推荐用哪个？
    
    答复：spateo的输入是注释后的矩阵，Stereo3D用的是图像（ssDNA）配准，是完全不一样的策略，这个没有具体评估过，看用户选择。感觉上可以先用图像配准，再用下游来微调。
    
4.  配准打分是对什么打分？多少分是比较好的，如何去判断配准的结果对不对？
    
    答复：配准打分，是对两两之间相邻的切片的配准结果进行打分。鼠胚胎项目的数据分数在84%左右，还是配的比较好的。果蝇数据有的配准打分是60%，但配准的结果是正确的。其实如果两片之间间隔较大，形态差异比较大，配准得分就有可能比较低。如果分数比较低，最好肉眼看下配准的结果，做个判断。（这个就要求客户了解组织的形态，前期也有建议，通过形态图谱、MRI或者CT去判断组织的形态；在包埋的时候提供包埋前后样本的一个状态，特别要求包埋的方向与预想的重构方位无明显偏移）。
    
5.  如果想加几张无矩阵的ssDNA图像到3D重构自动化流程里是否可以走通？
    
    答复：增加ssDNA图像用来改善3D model，自动化流程是可以走通的。
    
6.  如果样本数量过少，或者说样本质量差，是否要丢弃？
    
    答复：如果是样本数量过少，那最好确保最佳的样本用于正式实验，保证关键位置无误（最好由客户去确认芯片贴片的起始点和停止点，客户是最清楚自己的需求）。样本质量差，对于重构影响是不大的，但是对于后续的数据分析影响会比较大，例如扩散、捕获量低、基因数过少等，建议不要质量差的样本。
    
7.  从高档次期刊，肿瘤大小维度，建模后模型的漂亮程度来说，切多少片比较合适？
    
    答复：切片的数量和组织厚度是有关系的。还要根据所关注的组织器官，关注的科学问题，研究的物种组织的热点，关注本身的组织大小。例如组织个体比较小的话（4片就能切完），保证能把整个组织结构切出来即可，没必要切多。从期刊的高度来说，要关注其研究的热点。另外切的比较多，项目的整体方案，投入的比例会更多，产出自然也更多。但是经费有限的话，这一类就要关注所切的区域能否满足所关注的区域，而且后续也可以做一些整合，mapping，可以切少点整合前人做的3D结构。
    
8.  低分辨率，切片少；高分辨率，切片多。这两种适应场景，优劣势比较？
    
    答复：肿瘤数据的话，关注的是异质性，如果是关注肿瘤的生长结构，就不需要高分辨率。之前发文的时间段（2023年）比较早，当时达不到单细胞水平，所以当时选择了低分辨率的转录组结构。现在来说，高分辨率能达到单细胞水平，所描述的颗粒度不一样。如果说只做bin100，那更小的结构就没法识别。stereo-seq现在是能达到单细胞水平，老师能有更多角度去思考，可以选择。切片不是越多越好，更多是要从老师的角度考虑，考虑这个东西对老师解决问题是否有用。如果经费够，可以考虑结合其它技术，整个项目设计更加完善严谨，不局限于片子数量多少。片子满足老师技术要求下，发更好的文章。
    
9.  ssDNA和HE染色，如果是做3D项目，会推荐选哪个染色？
    
    答复：如果达到cellbin的，ssDNA会更稳定。
    
10.  如果有一批连续切片，但切片厚度不是相同的（比如一些是10微米，一些是5微米），在切片流水表的Meta信息里，Z-inteval的值应该怎么设置？
    

答复：要调整切到流水表里的Z\_index那列，该列表示每一张切片在Z轴上的距离，不是与前一张的间隔距离。例如第一张切了5微米，填写为5，第二张切了10微米，则填写15微米。（mesh会根据z-interval值构建）

# 附录

*   如果对Stereo3D感兴趣，想了解更多请查看相关文章：
    

3D鼠胚胎文章：

原肠胚文章：[https://www.sciencedirect.com/science/article/abs/pii/S1934590925001420?via%3Dihub](https://www.sciencedirect.com/science/article/abs/pii/S1934590925001420?via%3Dihub)

Spateo文章：[https://www.cell.com/cell/fulltext/S0092-8674(24)01159-0](https://www.cell.com/cell/fulltext/S0092-8674\(24\)01159-0)

时空组学技术Stereo-seq的3D重构解决方案，华大时空官网视频介绍：[https://www.stomics.tech/resources/Videos/1893.html](https://www.stomics.tech/resources/Videos/1893.html)

时空组学技术Stereo-seq助力3D图谱构建，华大时空官网视频介绍：[https://www.stomics.tech/resources/Videos/1892.html](https://www.stomics.tech/resources/Videos/1892.html)

*   Stereo3D用到的第三方软件清单
    

| 软件名称 | 下载链接 | 版本号 | 作用 |
| --- | --- | --- | --- |
| ImageStudio | [https://www.stomics.tech/service/stomics-software-download.html](https://www.stomics.tech/service/stomics-software-download.html) | 3.\* | *   对影像组数据进行质控，服务于SAW配准 |
| SAW | [https://www.stomics.tech/service/stomics-software-download.html](https://www.stomics.tech/service/stomics-software-download.html) | V7及之前 | *   完成转录组与影像组的配准<br>    <br>*   基于影像组完成组织分割 |
| Stereo3D | [https://github.com/STOmics/stereo3d](https://github.com/STOmics/stereo3d) | v0.0.1 | *   完成多组相邻片之间的配准<br>    <br>*   统一坐标系，生成3D model - 组织外包络面<br>    <br>*   输出多切片间配准后的矩阵 |
| 3DSlicer | [https://download.slicer.org/](https://download.slicer.org/) | v4.11.20210226 | *   修改模型外轮廓 |
| cloud compare | [https://www.danielgm.net/cc/](https://www.danielgm.net/cc/) | v2.12.4 | *   修改细胞注释内部点云 |
| blender | [https://www.blender.org/download/](https://www.blender.org/download/) | v4.0 | *   结果可视化、渲染 |
| Excel | \- | \- | *   制作切刀流水表 |