```
# Significance of 3D Reconstruction

Three-dimensional (3D) reconstruction is currently a research hotspot in the life sciences field. By constructing three-dimensional atlases, it is possible to restore the overall distribution of cells and molecules from the massive transcriptomic data of cells. This provides key assistance in solving many unresolved mysteries in research, such as the analysis of organ function, exploration of embryonic development mechanisms, studying the pathogenesis of cancer and other complex diseases, and tracing the evolutionary history of species.

This technology breaks through the limitations of traditional two-dimensional observation, allowing researchers to understand the relationships between gene expression, cell interactions, and biological phenotypes in a dimension closer to the original spatial configuration of biological entities. It opens up new perspectives and pathways for basic life science research and clinical translation (such as the discovery of disease diagnostic markers, design of targeted therapies, etc.).

# Introduction to the STOMICS 3D Reconstruction Solution Full Process and Functional Highlights

Traditional spatial transcriptomics technologies only provide two-dimensional information of tissue sections, unable to fully present the three-dimensional structure of biological samples and spatial relationships between cells. Even if high-resolution gene expression location detection can be achieved, specialized 3D reconstruction tools are still needed to solve the following challenges:

*   Accurate spatial registration of consecutive tissue sections
*   Integration and standardization of multi-slice data
*   3D visualization of cell types and gene expression patterns
*   Reconstruction of cross-section cell trajectories and developmental processes

Stereo3D is a three-dimensional reconstruction analysis platform developed by BGI Stereo-seq. It can integrate multi-slice spatial information to construct 3D gene expression atlases at the tissue and organ level, providing new perspectives for developmental biology, disease mechanism research, and tissue engineering.

The core advantages of Stereo3D make it a powerful research tool:

*   **Strong Versatility:** Flexibly adapts to various scenarios such as image-only, matrix-only, or combined image and matrix, meeting the analysis needs of different data types.
*   **High Efficiency and Low Cost:** Significantly reduces labor costs and shortens the analysis cycle (The fruit fly Demo can produce results in under ten minutes on a computer with 32GB memory).



Figure 1 Full Process of the 3D Reconstruction Solution

## Wet Lab Section Introduction (For reference only, link attached, no detailed introduction, linked to official website)

In the overall workflow of Stereo3D, the wet lab section is the key step for obtaining raw data. This part of the experiment is based on BGI's self-developed Stereo-seq technology, capturing mRNA information from tissue sections via the spatial chip. The experimental process includes precise sectioning of fresh tissue, mounting onto the spatial chip, followed by reverse transcription and cDNA amplification, recording the gene expression data at each spot on the chip. BGI's配套 reagent kits contain standardized reagents, ensuring experimental stability and data reliability.

To learn more about wet lab-related products and technical details, please visit the BGI website: [https://www.bgi.com/](https://www.bgi.com/).

## Data Analysis Process Introduction

The Stereo3D data analysis process is centered on automation and standardization, efficiently transforming raw data into 3D reconstruction results. At the input level, it supports GEM/GEF format gene expression matrices, tissue segmentation maps, and a slice record sheet documenting slice positions.

After the process starts, it first preprocesses the tissue segmentation maps for spatial alignment, constructing a unified 3D coordinate system; then performs matrix transformation, annotation, and other basic analyses; finally outputs registered tissue segmentation maps, H5AD data, 3D models (OBJ), etc., helping researchers quickly gain 3D spatial insights and solving the problems of low efficiency and high labor costs associated with traditional methods.

## Automated Solutions

The 3D reconstruction solution currently offers two automated methods: Stereo3D and Spateo.

The standardized Stereo3D workflow achieves 3D reconstruction by integrating radiological images and gene expression matrices, while also supporting 3D reconstruction based solely on images or solely on matrices. If the sample morphology is complete and needs to be combined with tissue morphology analysis, Stereo3D is preferred.

The difference with Spateo is that it does not rely on radiological images; it is entirely based on gene expression matrices, achieving 3D reconstruction without image dependency through statistical generative models. If the sample morphology varies significantly, Spateo is recommended.

### Stereo3D

#### Installation and Usage

Stereo3D is an open-source Python tool that supports deployment on Linux and macOS systems. The following are the quick start steps:

1.  Prepare the installation environment
    
    Please install Anaconda software first ([Anaconda Official Documentation](https://docs.anaconda.com/anaconda/install/)), then perform the following operations:
    
2.  Install Stereo3D
```

plaintext

# Clone the repository and navigate to the directory

git clone https://github.com/STOmics/stereo3d

cd stereo3d

# Create and activate the Conda environment

conda create --name=stereo3d python=3.8

conda activate stereo3d

# Install dependencies

pip install -r requirements.txt

```
3.  Run stereo3d_with_matrix.py
```

plaintext

python stereo3d_with_matrix.py \

--matrix_path E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.gem \

--tissue_mask E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.mask \

--record_sheet E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\E-ST20220923002_slice_records_E14_16.xlsx \

--output E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\output

```
For more installation details, parameter configuration, and case tutorials, please visit the [Stereo3D GitHub repository](https://github.com/STOmics/stereo3d); if you encounter problems, you are welcome to submit feedback or participate in discussions via GitHub Issues.

#### Input Parameter Introduction

If you have the standard output results from SAW, you need to first use the small tool `saw_hub.py` in Stereo3D (details can be found in 3.2.1 Stereo3D Input Standardization) to convert the data into the standard input format for Stereo3D.

Table 1 Stereo3D Standard Input Parameter Introduction

| **Input** | **Introduction** | **Necessity** | **Data Type** | **Remarks** |
| --- | --- | --- | --- | --- |
| matrix_path | Standard format gene expression matrix, supports raw.gef/gef/gem.gz | Required | string | / |
| tissue_mask | Tissue segmentation map, tif format | Required | string | / |
| record_sheet | Obtained from the experimental side, records slice positions, correspondence between consecutive slices | Required | string | / |
| output | Result save path | Required | string | / |
| registration | The process performs registration by default. If the input data is already registered and no additional algorithmic registration is needed, pass the parameter `--registration 0` | Optional | int | / |
| overwriter | If the automated Stereo3D registration result is unsatisfactory, perform manual registration operations on the automatically registered files, then reconnect to the Stereo3D process to output new results, pass the parameter `--overwriter 0` | Optional | int | Example can be found in 2.4.1.1 |
| align | If only the matrix is input, matrix reconstruction results can be generated, outputting only the registered H5AD and organ mesh, pass the parameter `--align paste` | Optional | int | Example can be found in 3.2.3.2 |

#### Standard Output File Introduction

| **Output File** | **Introduction** |
| --- | --- |
| 02.register | Registered tissue mask images after alignment |
| 03.gem | Spatial expression matrix after registration |
| 04.mesh | 3D mesh model reconstructed from clustered point clouds |
| 05.transform | Annotated H5AD file containing spatial coordinates and cell metadata |
| 06.color | H5AD file with unified color mapping for visualization |
| 07.organ | Segmented organ-specific mesh models |

#### Viewing Results

After data standardization and running `stereo3d_with_matrix.py` to output results, the results can be viewed in the following ways.

##### Viewing Registration Results

Since the image and matrix have a one-to-one correspondence, the matrix transformation reuses the image registration relationship. Therefore, it is only necessary to check if the image registration is correct.

The output result folder `02.register` contains `00.crop_mask` (cropped tissue mask) and `01.align_mask` (registered tissue mask).

| Tool | Version | Introduction | Download Link | Purpose | BGI Pan Download Link |
| --- | --- | --- | --- | --- | --- |
| Fiji | ImageJ 1.54f | Fiji is a free, open-source image processing software based on ImageJ, supporting fluorescence microscopy images, 3D reconstruction, cell counting, etc. | [https://imagej.net/software/fiji/downloads](https://imagej.net/software/fiji/downloads) | *   View registration results<br><br>*   Manually modify registration results | [https://bgipan.genomics.cn/#/link/OvDFhNolvDYrxCO8l8V0](https://bgipan.genomics.cn/#/link/OvDFhNolvDYrxCO8l8V0) Extraction password: RdpK |

Note: When using Fiji software to view, importing into TrakEM2 displays the images sorted by filename (according to the default alphanumeric order). Therefore, it is recommended to name the files according to the order in the slice record sheet (e.g., image1.tif, image2.tif) to ensure the correct sequence relationship between consecutive slices.

*   Create a project: Open Fiji software and create an empty TrakEM2;
    



*   Select directory: In the "Select storage folder" window, choose the `01.align_mask` folder (the directory containing the images);
    



*   Remove other files: Move the `align_info.json` file out of the `01.align_mask` folder (the folder imported into TrakEM2 should only contain images, no other files);
    
*   Import folder: Drag the `01.align_mask` folder into the "Canvas" (the largest image display area); In the "Import directory" window, click "OK"; In the "Slice separation" window, check "Lock stack";
    
    
    
      
    
    
    
*   Adjust image position: If you need to adjust the display position of the image in the "Canvas", first place the mouse on the "Preview thumbnail", hold down "Ctrl", and scroll the mouse wheel to adjust the image's display position in the "Canvas"; you can also click the red box in the "Preview thumbnail" and move it up, down, left, or right until the image display is suitable;
    
    
    
*   Unlink layers: In the "Patches" window, unlink the patches (so that the reference image can subsequently be transformed);
    
    
    
*   Switch to the "Layers" window: In the "Layers" window, the number of indicator bars on the left equals the number of files in the imported folder. Scrolling the mouse wheel will cause the indicator bars to turn green in turn, and the "Canvas" will display different images in sequence;
    
    
    
*   Image selection: The indicator bar for the reference image is red, and the indicator bar for the image to be adjusted is green; select the indicator bar of the image to be adjusted (it turns green when selected); press the "Shift" key and click on other indicator bars in the left panel, then the reference image's indicator bar will turn red;
    
    
    
*   View registration results: Scroll the mouse wheel to view the registration between consecutive slices.
    



##### H5AD Result Visualization

The output result `06.color` is an H5AD file with unified coordinates and labels. Use the small tool `stereo3d_viewer.ipynb` in Stereo3D for visualization. Specific operations can be found in [《Annotation/Clustering Breakpoint Integration and Display》](https://alidocs.dingtalk.com/i/nodes/lyQod3RxJK3djBrof2e4bK7dJkb4Mw9r)**---Usage Scenario: Annotation/Clustering Effect Display**

##### Mesh/Organ Visualization

The output result `04.mesh` is the entire tissue model, and `07.organ` is the organ model. Use 3D Slicer for visualization (models are stored in OBJ format).

| Tool | Version | Introduction | Download Link | Purpose |
| --- | --- | --- | --- | --- |
| 3D Slicer | v4.11.20210226 | Supports 3D reconstruction, segmentation, and visualization of multi-dimensional medical data such as CT, MRI, etc. | [https://download.slicer.org/](https://download.slicer.org/) | *   Model visualization<br><br>*   Modify model outer contour |

Note: The OBJ save path should not contain Chinese characters.

*   Import files: Drag the files from the `04.mesh` folder into 3D Slicer;
    



*   View results: In the 3D view, click the "center the 3D" button in the upper left corner to reset the model position. Scrolling the mouse wheel zooms in/out (holding the left mouse button allows free rotation; holding the right mouse button or mouse wheel adjusts the model size).
    



*   Mesh and organ visualization: Drag the files from the `07.organ` folder into 3D Slicer to display together with the mesh;
    





*   Adjust model display color: In the "Models" module, double-click the color window, a "Slicer" window will pop up, select a color to change the display color;
    





*   Show/hide parts of the OBJ: Click the eye icon. Closing the eye hides the model, opening the eye shows it.
    



### Spateo

Spateo focuses on computational analysis of spatial transcriptomics data, such as 3D reconstruction and spatial pattern mining (e.g., slice registration, cell trajectory construction). Spateo-viewer is the配套的可视化 tool designed specifically to display the analysis results of Spateo. It can present complex 3D spatial structures, gene expression patterns, etc., in an interactive manner. Together, they form a complete "analysis - visualization" workflow.

#### Installation and Usage

Spateo is a tool developed based on Python. The following are the quick start steps:

1.  Prepare the installation environment
    
    Please install Anaconda software first ([Anaconda Official Documentation](https://docs.anaconda.com/anaconda/install/)), then perform the following operations:
    
2.  Install Spateo and Spateo-viewer
```

plaintext

# Clone the repository and navigate to the directory

git clone https://github.com/STOmics/stereo3d

cd stereo3d/stereo3d/tools

# Create and activate the Conda environment

conda create --name=spateo python=3.9

conda activate spateo

# Install dependencies

pip install pymeshfix

pip install pyacvd

pip install scanpy

pip install spateo-release==1.1.1

plaintext

# Clone the repository and navigate to the directory

git clone https://github.com/aristoteleo/spateo-viewer.git

cd spateo-viewer

# Install dependencies

pip install -r requirements.txt

# Note: vtk==9.2.2 can solve TypeError: Could not find a suitable VTK type for <U54

```
3.  Run spateo_3d.py and stv_explorer.py
```

plaintext

python spateo_3d.py \

-input D:\RD_Data\3D\spateo_data\E14-16h_a_count_normal_stereoseq.h5ad \

-output D:\RD_Data\3D\spateo_data\output \

-z_step 1 \

-slice slice_ID \

-cluster annotation \

-cluster_pts 1000

plaintext

python stv_explorer.py --port 1234

```
*   For more installation details, parameter configuration, and case tutorials, please visit the [spateo-release GitHub](https://github.com/aristoteleo/spateo-release) repository and the [spateo-viewer GitHub](https://github.com/aristoteleo/spateo-viewer) repository.
    
*   Spateo article: [https://www.cell.com/cell/fulltext/S0092-8674(24)01159-0](https://www.cell.com/cell/fulltext/S0092-8674\(24\)01159-0)
    
    #### Input Parameter Introduction
    
    | **Input** | **Introduction** | **Necessity** | **Data Type** |
    | --- | --- | --- | --- |
    | input | File or directory path.<br>File path: All slices are in one file;<br>Directory path: All slices are in one directory (filenames should contain numbers to reflect the inter-slice relationship) | Required | string |
    | output | Result save path | Required | string |
    | z_step | The distance between slices can be adjusted based on the rendering effect in spateo-viewer | Optional | int |
    | slice | The field name in the H5AD file that represents the sequential relationship between slices | Optional | string |
    | cluster | The field name in the H5AD file where the clustering information is stored | Optional | string |
    | cluster_pts | When the number of points used to describe the 3D tissue expression information is too large, downsampling can be used, and the sampled data can be used for process analysis. This parameter sets the number of points sampled per cluster. Use with caution when the point count is low. | Optional | int |
    
    #### Output File Introduction
    
    | **Output File** | **Introduction** |
    | --- | --- |
    | h5ad | AnnData object processed by count normalization and spatial alignment, containing gene expression matrix and spatial coordinate information. |
    | matrices | Raw or preprocessed gene expression matrix files |
    | mesh_models | Segmented organ-specific mesh models |
    | pc_models | Aligned organ-specific point cloud model containing coordinates and attributes of discrete cells/sites in 3D space |
    | plot | Visualized results file |
    | trans_h5ad | AnnData after normalization, alignment, and secondary processing, with analysis data |
    
    #### Viewing Results
    
    For details, please see the [spateo-viewer GitHub](https://github.com/aristoteleo/spateo-viewer) repository.
    
    ## Manual Assisted Refinement Solution
    
    If the results of the Stereo3D automated process are unsatisfactory, you can manually modify the results and then reconnect to the process.
    
    #### Manual Registration
    
    If the registration result in the Stereo3D automated process is incorrect, you can perform manual registration and then reconnect to Stereo3D to output new automated process results. For specific operations, please refer to this document: [《Manual Registration SOP_v1》](https://alidocs.dingtalk.com/i/nodes/93NwLYZXWyg6oqO1FvX5EgreJkyEqBQm?corpId=dingdaeb6f85c48618b9f2c783f7214b6d69&iframeQuery=utm_source%3Dportal%26utm_medium%3Dportal_new_tab_open&rnd=0.6391902675229961&sideCollapsed=true&utm_scene=team_space)
    
    #### Manual Mesh Modification
    
    If you are unsatisfied with the mesh or organ results from the Stereo3D automated process, you can use 3D Slicer for manual modification. (Since the model results do not affect other file results, there is no need to reconnect to the Stereo3D process).
    
    [《3Dslicer Manual Modification of mesh/organ SOP_v1》](https://alidocs.dingtalk.com/i/nodes/Gl6Pm2Db8D30K1wofqZaoawzJxLq0Ee4?doc_type=wiki_doc)
    
    # Application Case Introduction
    
    ## Test Data Introduction
    
    | Species Tissue | Download Path | File Size |
    | --- | --- | --- |
    | Drosophila | https://bgipan.genomics.cn/#/link/wSnaxQhJ6i5RTPcYvtgI Extraction password:FJrY | 90 MB |
    
    ### Drosophila Automated Process Demonstration
    
    1.  Environment Configuration
```

plaintext

\# Clone the repository and navigate to the directory

git clone https://github.com/STOmics/stereo3d

cd stereo3d

````
# Create and activate the Conda environment
conda create --name=stereo3d python=3.8
conda activate stereo3d

# Install dependencies
pip install -r requirements.txt
```

2.  Code Execution

```plaintext
python stereo3d_with_matrix.py \
--matrix_path E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.gem \
--tissue_mask E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.mask \
--record_sheet E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\E-ST20220923002_slice_records_E14_16.xlsx \
--output E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\output
```

3.  Log Display



4.  Output Result Display


  

Pairwise Registration Result Display



Model Result Display



Post-Clustering Effect Display

## Scenario Introduction

### Image and Matrix Scenario

The image and matrix scenario is the standardized workflow for Stereo3D. For details, please refer to 3.1.1 Drosophila Automated Process Demonstration.

### Image-Only Scenario

When only images are available, Stereo3D can be used to generate tissue reconstruction results. The `--matrix_path` input requires a path placeholder but does not need an actual matrix as input.

Usage

```plaintext
python stereo3d_with_matrix.py \
--matrix_path E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.gem \
--tissue_mask E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.mask \
--record_sheet E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\E-ST20220923002_slice_records_E14_16.xlsx \
--output E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\output
```

Output file

| **File Name** | **Description** |
| --- | --- |
| 02.register | Registered tissue mask images after alignment |
| 03.gem | Spatial expression matrix after registration |
| 04.mesh | 3D mesh model reconstructed from clustered point clouds |
| 05.transform | empty |
| 06.color | empty |
| 07.organ | empty |

If a specific structure within the tissue needs to be displayed separately, that structure can be clustered into a single category and processed through Stereo3D to generate its model. For more details, please submit feedback or participate in discussions via GitHub Issues.

### Matrix-Only Scenario

When only matrix files are available, without images, Stereo3D can be used for reconstruction. Alternatively, Spateo can be chosen for reconstruction; see 2.3.2 Spateo.

#### Stereo3D---Tissue Reconstruction

If you want to obtain the mesh of the entire tissue, tissue segmentation can be performed based on the matrix. The generated tissue segmentation mask can then be used as input for Stereo3D to obtain its standard output results.

For tissue segmentation based on the matrix, cellbin2 can be utilized. For specific operations, see the link: [https://github.com/STOmics/cellbin2/blob/main/cellbin2/config/demos/only_matrix.json](https://github.com/STOmics/cellbin2/blob/main/cellbin2/config/demos/only_matrix.json)

After obtaining the tissue segmentation results from the matrix, you have the standard input for Stereo3D. The subsequent process can refer to 3.1.1 Drosophila Automated Process Demonstration.

#### Stereo3D---Matrix Reconstruction

If you only want to obtain matrix reconstruction results, you can use the `paste` parameter in Stereo3D, which outputs the registered H5AD and organ mesh.

Usage

```plaintext
python stereo3d_with_matrix.py \
--matrix_path D:\RD_Data\3D\Drosophila_melanogaster_demo\00.gem \
--record_sheet D:\RD_Data\3D\E-ST20220923002_slice_records_E14_16.xlsx \
--output D:\RD_Data\3D\Drosophila_melanogaster_demo\output \
--align paste
```

Input Parameters

| **Name** | **Description** | **Importance** | **Dtype** |
| --- | --- | --- | --- |
| matrix_path | The path of matrix file | Required | string |
| record_sheet | Record sheet file. We provide you with a sample, click for detail | Required | string |
| output | The output path | Required | string |
| align | Using the paste method to achieve alignment | Required | string |

Output file

| **File Name** | **Description** |
| --- | --- |
| 06.color | H5AD file with unified color mapping for visualization |
| 07.organ | Segmented organ-specific mesh models |

## Intelligent Assistant Tools Introduction

Stereo3D is also equipped with a series of practical small tools to adapt to different scenarios. The following will specifically introduce the application of these tools in various scenarios.

### Stereo3D Input Standardization

If you have the standard output results from SAW, in addition to manual input standardization, you can use the small tool `saw_hub.py` in Stereo3D to convert the data into the standard input format for Stereo3D. `saw_hub.py` prioritizes obtaining `raw.gef` from the SAW standard output results; if not available, it obtains `gem.gz` and automatically converts `gem.gz` to `gef`.

#### Usage

```shell
python saw_hub.py \
-input D:\data\stereo3d\input \
-record D:\code\stereo3d\docs\E-ST20220923002_slice_records_20221110.xlsx \
-stain ssDNA \
-output D:\data\stereo3d\output \
-saw_version 7
```

#### Input Parameters

| **Name** | **Description** | **Importance** | **Dtype** |
| --- | --- | --- | --- |
| input | SAW output directory | Required | string |
| record | Input record sheet path | Required | string |
| output | The output path | Required | string |
| saw_version | The version of SAW (7 or 8) | Required | int |
| stain | The stain technology (ssDNA or HE) | Required | string |

#### Output file

| **File Name** | **Description** |
| --- | --- |
| gem | The gene matrix files (SAW input format) |
| mask | The tissue segmentation files from SAW output (`<SN>_<staintype>_tissue_cut.tif`), [details](https://stereotoolss-organization.gitbook.io/saw-user-manual-v8.2/analysis/outputs/count-outputs) |

### Multiple Tissues on One Chip Scenario Processing

Due to small tissue size, multiple sections are mounted on one spatial chip, or multiple tissues are embedded in one block for sectioning, resulting in multiple tissues on one chip. For such data, on the experimental side, xxxxxx (to be added later) is required; on the data processing side, they need to be split into individual tissues before being input into the Stereo3D process for reconstruction. For data processing, there are manual splitting and automatic splitting solutions.

1.  Manual Splitting Solution primarily uses StereoMap and SAW tools. For specific operations, please see [《Manual Splitting Solution for Multiple Tissues on One Chip》](https://alidocs.dingtalk.com/i/nodes/P7QG4Yx2Jp7moAR1H4Ar1DeeV9dEq3XD)

2.  Automatic Splitting Solution uses the tool `multi_tissue.py` within Stereo3D. For specific operations, please see [《Automatic Splitting Solution for Multiple Tissues on One Chip》](https://alidocs.dingtalk.com/i/nodes/AR4GpnMqJzM3oe71CKwbxXNlVKe0xjE3)
````

### Annotation/Clustering Result Breakpoint Integration Function

`anno_adata_support.py`is a tool designed for spatial transcriptomics data analysis, used to integrate already annotated/clustered H5AD format data (Scanpy standard) as a breakpoint into the Stereo3D analysis workflow. This tool seamlessly integrates external annotation data based on the original Stereo3D analysis results, generating new Stereo3D results while preserving all intermediate results from the original analysis process.

For specific operations, please see 《Annotation/Clustering Breakpoint Integration and Display》---**Usage Scenario: Annotation/Clustering Breakpoint Integration**

### Adding Images Without Matrix for Reconstruction

Adding images without matrix information to improve the 3D model is feasible within the Stereo3D workflow. Fill in the complete SNs used for reconstruction in the slice record sheet, ensuring the correct sequence relationship between consecutive slices, and finally run `stereo3d_with_matrix.py`.

```
python stereo3d_with_matrix.py \
--matrix_path E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\01.gem \
--tissue_mask E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\00.mask \
--record_sheet E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\E-ST20220923002_slice_records_E14_16.xlsx \
--output E:\3D_demo\Drosophila_melanogaster\00.raw_data_matrix\Drosophila_melanogaster_demo\output
```

# Q&A

1. If the number of samples is too small or the sample quality is poor, should they be discarded?Reply: If the number of samples is too small, it is best to ensure the optimal samples are used for the formal experiment, guaranteeing key positions are correct (preferably confirmed by the customer regarding the start and stop points for chip mounting, as the customer knows their needs best). Poor sample quality has little impact on reconstruction but a significant impact on subsequent data analysis, such as diffusion, low capture rate, insufficient gene count, etc. It is recommended not to use poor-quality samples.
2. In 3D reconstruction, there is a non-mandatory requirement: the number of sequenced genes in adjacent slice bin50 should not differ by more than 30%. If different bin sizes are used, should corresponding adjustments be made?Reply: Yes, corresponding adjustments should be made for different bin sizes.
3. Which is more recommended for 3D reconstruction, Stereo3D or Spateo?Reply: Spateo's input is an annotated matrix, while Stereo3D uses image (ssDNA) registration; they are completely different strategies. There hasn't been a specific evaluation on this; it depends on the user's choice. Intuitively, one could use image registration first and then use downstream tools for fine-tuning.
4. What does the registration score evaluate? What score is considered good, and how to judge if the registration result is correct?Reply: The registration score evaluates the registration result between two adjacent slices. Data from the mouse embryo project had scores around 84%, which is quite good. Some fruit fly data had registration scores of 60%, but the registration results were correct. Actually, if the gap between two slices is large and the morphological difference is significant, the registration score might be lower. If the score is low, it's best to visually inspect the registration result and make a judgment. (This requires the customer to understand the tissue morphology. It was also suggested earlier to use morphological atlases, MRI, or CT to determine tissue morphology; provide the state of the sample before and after embedding, especially ensuring the embedding direction has no significant deviation from the intended reconstruction orientation).
5. Is it feasible to add a few ssDNA images without matrix information to the 3D reconstruction automated workflow?Reply: Adding ssDNA images to improve the 3D model is feasible within the automated workflow.
6. If the number of samples is too small or the sample quality is poor, should they be discarded?Reply: (Duplicate question, answer same as Q1) If the number of samples is too small, it is best to ensure the optimal samples are used for the formal experiment, guaranteeing key positions are correct. Poor sample quality has little impact on reconstruction but a significant impact on subsequent data analysis. It is recommended not to use poor-quality samples.
7. From the perspective of high-impact journals, tumor size dimensions, and the aesthetic quality of the modeled results, how many slices are appropriate?Reply: The number of slices is related to tissue thickness. It also depends on the target tissue/organ, the scientific questions being addressed, the hotspots of the species/tissue under study, and the size of the tissue itself. For example, if the tissue is small (can be fully sectioned in 4 slices), ensure the entire tissue structure is captured; there's no need to cut more. From a journal's perspective, focus on research hotspots. Furthermore, cutting more slices increases the overall project scale, investment, and naturally, the output. However, if funding is limited, focus on whether the sectioned area can cover the region of interest. Subsequent integration and mapping with previously published 3D structures can also be considered, potentially requiring fewer slices.
8. Comparison of application scenarios, advantages, and disadvantages between low resolution (fewer slices) and high resolution (more slices)?Reply: For tumor data, if heterogeneity is the focus, and if the tumor growth structure is the main interest, high resolution might not be necessary. During the earlier publication period (around 2023), single-cell resolution wasn't always achievable, so low-resolution transcriptome structures were chosen. Now, high resolution can achieve single-cell level, offering different granularity. If only bin100 is used, smaller structures cannot be identified. Stereo-seq can now achieve single-cell level, giving researchers more angles to consider and choose from. More slices are not always better; it's more important to consider the researcher's perspective and whether it helps solve their problem. If funding allows, consider combining other technologies to make the entire project design more robust and rigorous, not limited solely by the number of slices. Under the premise of meeting the technical requirements, aim for better publications.
9. For a 3D project, which staining would be recommended, ssDNA or HE?Reply: If aiming for cellbin-level resolution, ssDNA is more stable.
10. If there is a batch of consecutive slices, but the slice thickness is not uniform (e.g., some are 10 microns, some are 5 microns), how should the Z-interval value be set in the Meta information of the slice record sheet?

Reply: The `Z_index`column in the slice record sheet needs to be adjusted. This column represents the cumulative distance of each slice on the Z-axis, not the interval from the previous slice. For example, if the first slice is 5 microns thick, enter 5; if the second slice is 10 microns thick, enter 15 microns. (The mesh will be constructed based on these z-interval values).

# Appendix

- If you are interested in Stereo3D and want to learn more, please check the related articles:

3D Mouse Embryo Articles:

Gastrula Article: https://www.sciencedirect.com/science/article/abs/pii/S1934590925001420?via%3Dihub

Spateo Article: https://www.cell.com/cell/fulltext/S0092-8674(24)01159-0

Stereo-seq Spatial Transcriptomics Technology 3D Reconstruction Solution, BGI Stereo-seq Official Website Video Introduction: https://www.stomics.tech/resources/Videos/1893.html

Stereo-seq Spatial Transcriptomics Technology Assists 3D Atlas Construction, BGI Stereo-seq Official Website Video Introduction: https://www.stomics.tech/resources/Videos/1892.html

- List of Third-Party Software Used by Stereo3D

| Software Name | Download Link                                                | Version            | Purpose                                                      |
| :------------ | :----------------------------------------------------------- | :----------------- | :----------------------------------------------------------- |
| ImageStudio   | https://www.stomics.tech/service/stomics-software-download.html | 3.*                | * Quality control of imaging data, serving SAW registration  |
| SAW           | https://www.stomics.tech/service/stomics-software-download.html | V8, V7 and earlier | * Complete registration between transcriptome and imaging data  * Perform tissue segmentation based on imaging data |
| Stereo3D      | https://github.com/STOmics/stereo3d                          | v0.0.1             | * Perform registration between multiple adjacent slices  * Unify coordinate system, generate 3D model - tissue outer envelope  * Output registered matrices across multiple slices |
| 3D Slicer     | https://download.slicer.org/                                 | v4.11.20210226     | * Modify model outer contour                                 |
| Cloud Compare | https://www.danielgm.net/cc/                                 | v2.12.4            | * Modify internal point cloud of cell annotations            |
| Blender       | https://www.blender.org/download/                            | v4.0               | * Result visualization, rendering                            |
| Excel         | -                                                            | -                  | * Create slice record sheet                                  |